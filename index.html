<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 é—œè¥¿å®¶æ—ä¹‹æ—… - æ——è‰¦å°éŠç‰ˆ</title>
    <!-- å·²æ›´æ›ç‚ºç²¾ç·»ç´…è‰²é³¥å±…åœ–ç¤º -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/619/619028.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Ma+Shan+Zheng&display=swap');
        
        :root {
            --kyoto-red: #B22D15;
            --bamboo-green: #3A4D39;
            --osaka-gold: #D4AF37;
            --washi-bg: #F9F6F0;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--washi-bg);
            color: #2D3436;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .calligraphy { font-family: 'Ma Shan Zheng', cursive !important; }
        .kaity { font-family: 'DFKai-SB', 'æ¨™æ¥·é«”', 'Kaiti TC', 'KaiTi', serif !important; }

        .tab-active {
            background: var(--kyoto-red) !important;
            color: white !important;
            box-shadow: 0 8px 20px rgba(178, 45, 21, 0.35);
            transform: scale(1.08);
        }

        .glass-tool {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1) forwards; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-immersive-header {
            height: 320px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .modal-immersive-overlay {
            background: linear-gradient(to bottom, rgba(249, 246, 240, 0.1) 0%, rgba(249, 246, 240, 0.9) 100%);
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .text-shadow-premium {
            text-shadow: 0 0 15px rgba(255, 255, 255, 1), 0 0 5px rgba(255, 255, 255, 0.8);
        }

        .badge-spot { background: #E6F3FF; color: #007AFF; }
        .badge-food { background: #FFF4E6; color: #FF9500; }
        
        .btn-press:active { transform: scale(0.92); opacity: 0.8; }
        
        .checklist-item input:checked + span {
            text-decoration: line-through;
            color: #9CA3AF;
        }

        #stamina-ring {
            transition: stroke-dashoffset 1.2s ease-out;
        }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl min-h-screen pb-48 relative">

    <!-- é ‚éƒ¨æ¨™é¡Œå€åŸŸ -->
    <header id="main-header" class="bg-[#3A4D39] text-white p-8 rounded-b-[4rem] shadow-2xl relative overflow-hidden min-h-[220px] flex flex-col justify-end">
        <img id="header-bg" src="https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=1200&q=80" class="absolute inset-0 w-full h-full object-cover opacity-45 transition-all duration-700">
        <div class="absolute inset-0 bg-gradient-to-t from-[#3A4D39] via-transparent to-transparent opacity-80"></div>
        
        <div class="relative z-10 flex justify-between items-end">
            <div class="flex-1 overflow-hidden pb-1">
                <h1 class="text-4xl font-black kaity text-gray-900 leading-none text-shadow-premium mb-1">é—œè¥¿å°é†‰é†‰</h1>
                <p class="text-xs font-bold text-yellow-100/80 tracking-widest uppercase">Kansai Luxury Travel 2025</p>
            </div>
            <div class="text-right flex flex-col items-end">
                <p id="weather-city-name" class="text-7xl calligraphy text-yellow-50 leading-none mb-1 drop-shadow-md">--</p>
                <div class="flex items-center justify-end gap-2 pr-1">
                    <span id="weather-icon-inline" class="text-base opacity-90"></span>
                    <p id="weather-temp-calligraphy" class="text-4xl calligraphy text-yellow-100 leading-none">--Â°C</p>
                </div>
            </div>
        </div>
    </header>

    <!-- å·¥å…·å°èˆªæŒ‰éˆ• -->
    <section class="px-4 -mt-10 relative z-20 flex justify-center gap-2 text-center">
        <button onclick="window.toggleTool('calc')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-calculator text-[--osaka-gold] mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">åŒ¯ç‡</span>
        </button>
        <button onclick="window.toggleTool('ledger')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-coins text-emerald-600 mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">è¨˜å¸³</span>
        </button>
        <button onclick="window.toggleTool('trans')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-language text-blue-500 mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">ç¿»è­¯</span>
        </button>
        <button onclick="window.toggleTool('checklist')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-clipboard-list text-purple-500 mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">æ¸…å–®</span>
        </button>
    </section>

    <!-- å¤©æ°£æé†’ -->
    <div id="weather-tip" class="px-6 mt-6 hidden">
        <div class="bg-white/80 border-l-4 border-[--kyoto-red] p-4 rounded-r-2xl shadow-sm backdrop-blur-md flex items-center gap-3">
            <i class="fas fa-info-circle text-[--kyoto-red]"></i>
            <p id="weather-tip-text" class="text-[12px] font-bold text-gray-700"></p>
        </div>
    </div>
    
    <!-- æ—¥æœŸåˆ‡æ›å°èˆª -->
    <nav class="flex overflow-x-auto whitespace-nowrap px-4 py-8 no-scrollbar sticky top-0 z-40 bg-[--washi-bg]/95 backdrop-blur-md">
        <div class="flex space-x-4 mx-auto px-4" id="day-nav-container"></div>
    </nav>

    <!-- ä¸»è¡Œç¨‹å…§å®¹å€ -->
    <main id="main-content" class="px-6 min-h-[400px]"></main>

    <!-- å½ˆçª—æ¨¡çµ„ -->
    <div id="tool-modal" class="hidden fixed inset-0 z-[100] flex items-end justify-center bg-black/60 backdrop-blur-md">
        <div class="bg-[--washi-bg] w-full max-w-md rounded-t-[3rem] shadow-2xl overflow-hidden animate-slideUp max-h-[92vh] flex flex-col relative">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mt-4 mb-2"></div>
            <button onclick="window.closeModal()" class="absolute top-6 right-6 z-50 w-10 h-10 rounded-full bg-black/10 text-gray-600 flex items-center justify-center active:scale-90"><i class="fas fa-times"></i></button>
            <div id="modal-body" class="flex-1 overflow-y-auto no-scrollbar pb-10"></div>
        </div>
    </div>

    <!-- åº•éƒ¨å¸¸é§å°èˆª -->
    <footer class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/95 backdrop-blur-3xl rounded-[2.5rem] shadow-2xl border border-white p-5 z-50 flex justify-between items-center px-10 safe-pb">
        <a href="tel:0901234567" class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-red-50 text-[--kyoto-red] flex items-center justify-center mb-1 shadow-sm">
                <i class="fas fa-phone-alt text-xl"></i>
            </div>
            <span class="text-[8px] font-black text-gray-500 uppercase tracking-tighter">è¯ç¹«å¸æ©Ÿ</span>
        </a>
        <div class="text-center relative -top-2">
            <div class="relative w-16 h-16 mx-auto">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="32" cy="32" r="28" stroke="#f0f0f0" stroke-width="4" fill="transparent" />
                    <circle id="stamina-ring" cx="32" cy="32" r="28" stroke="var(--kyoto-red)" stroke-width="4" fill="transparent" stroke-dasharray="176" stroke-dashoffset="176" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center font-black text-[--kyoto-red]">
                    <span id="stamina-val" class="text-sm font-black">--%</span>
                </div>
            </div>
            <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest">å®¶æ—é«”åŠ›</span>
        </div>
        <button onclick="window.toggleTool('trans')" class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-1 shadow-sm font-black">
                <i class="fas fa-robot text-xl"></i>
            </div>
            <span class="text-[8px] font-black text-gray-500 uppercase tracking-tighter">AI åŠ©æ‰‹</span>
        </button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = ""; 

        // 1. å…¨å±€è¡Œç¨‹è³‡æ–™åº«
        const tourData = {
            1: { 
                label: "Day 1 å¤§é˜ªãƒ»ç¾é£Ÿå¼·æ”»", loc: "å¤§é˜ª", engLoc: "Osaka", img: "https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=1200&q=80", stamina: 85, 
                events: [
                    { t: "09:20", s: "æ¡ƒåœ’æ©Ÿå ´ | æ˜Ÿå®‡ JX822", type: "äº¤é€š", i: "plane-departure", n: "æ˜Ÿå®‡èˆªç©º JX822 å•Ÿèˆªï¼Œå¤¢æƒ³èµ·é£›ã€‚", m: "Taoyuan+Airport", imgDetail: "https://images.unsplash.com/photo-1530521954074-e64f6810b32d?auto=format&fit=crop&w=800", detailTitle: "æ˜Ÿå®‡ JX822 å•Ÿèˆª", intro: "å…­å¤©äº”å¤œé—œè¥¿ä¹‹æ—…æ­£å¼é–‹å•Ÿã€‚æ˜Ÿå®‡èˆªç©ºæ©Ÿä¸Šè¨­æ–½å®Œå–„ï¼Œé•·è¼©å¯ä»¥çœ‹é›»å½±æ”¾é¬†ã€‚", aiGuide: "å°éŠè§€é»ï¼šæ¡ƒåœ’ç¬¬äºŒèˆªå»ˆã€‚å»ºè­° 06:50 æŠµé”å ±åˆ°ï¼Œäº«å—æ©Ÿä¸Šèƒ¡åŒç‡’è‚‰ã€‚", mustEat: "èƒ¡åŒç‡’è‚‰æ©Ÿä¸Šé¤ã€‚" },
                    { t: "12:50", s: "æŠµé”é—œè¥¿æ©Ÿå ´ | KIX", type: "äº¤é€š", i: "plane-arrival", n: "å®Œæˆé€šé—œç”±å°ˆå±¬å¸æ©Ÿæ¥æ©Ÿã€‚", m: "KIX", imgDetail: "https://images.unsplash.com/photo-1569154941061-e231b4725ef1?auto=format&fit=crop&w=800", detailTitle: "æŠµé”å¤§é˜ª", intro: "å®Œæˆé€šé—œé ˜å–è¡Œæã€‚é—œè¥¿æ©Ÿå ´ç¬¬ä¸€èˆªå»ˆå…¥å¢ƒã€‚", aiGuide: "å°éŠè§€é»ï¼šå¸æ©Ÿåœ¨å¤§å»³è¿æ¥ï¼Œè¡Œæå…æç›´é”é£¯åº—ã€‚" },
                    { t: "15:30", s: "é ‚ç´šå’Œç‰›ï¼šMouriya ç¥æˆ¶ç‰›", type: "é¤å»³", i: "fire", n: "äº«å—å…¥å£å³åŒ–çš„ç¥æˆ¶å’Œç‰›ã€‚", m: "Mouriya+Osaka", imgDetail: "https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800", detailTitle: "éœ‡æ’¼ç¥æˆ¶ç‰›", intro: "ç’°å¢ƒå„ªé›…ã€æœå‹™æ¥µå¥½ã€‚å…¥å£å³åŒ–çš„ç¥æˆ¶å’Œç‰›è®“é•·è¼©è¶…æ»¿æ„ã€‚", aiGuide: "å°éŠè§€é»ï¼šç¥æˆ¶ç‰›æ’å¥—é¤å£æ„Ÿç´°ç·»ï¼Œé•·è¼©åš¼èµ·ä¾†ä¹Ÿæ²’è² æ“”ã€‚", mustEat: "ç¥æˆ¶ç‰›æ’å¥—é¤ã€‚", reserved: true, accessible: true },
                    { t: "17:30", s: "èŸ¹é“æ¨‚ ç¸½åº—", type: "é¤å»³", i: "utensils", n: "é“é “å €æ¨™èªŒï¼Œæ¥µå“èƒèŸ¹å®´ã€‚", m: "Kani+Doraku", imgDetail: "https://i.ibb.co/XZcYVWYz/image.jpg", detailTitle: "åœ°æ¨™èƒèŸ¹å¤§é¤", intro: "å·¨å¤§èƒèŸ¹æ‹›ç‰Œå¿…æ‹ã€‚èƒèŸ¹æ–™ç†æ¸…æ·¡ï¼Œç‰¹åˆ¥å—é•·è¼©æ­¡è¿ã€‚", aiGuide: "å°éŠè§€é»ï¼šå·²é ç´„ 5:30 çª—é‚Šä½ã€‚è‹¥æœ‰éœ€è¦å¯ä¿¯ç°é“é “å €è¡—æ™¯ã€‚", mustEat: "èƒèŸ¹é‡œé£¯ã€åˆºèº«ã€‚", reserved: true, accessible: true },
                    { t: "19:30", s: "é“é “å € & ç¾æ´¥ã®å¤§é˜ªç‡’", type: "é¤å»³", i: "camera", n: "æ ¼åŠ›é«˜è·‘è·‘äººåˆå½± & ç±³å…¶æ—ç¾é£Ÿã€‚", m: "Mizuno", imgDetail: "https://i.ibb.co/qwJrr50/image.jpg", detailTitle: "é“åœ°å¤§é˜ªå‘³", intro: "ç±³å…¶æ—æ¨è–¦ååº—ã€‚è‹¥ä¸æ’éšŠå¯é¸åƒæˆ¿æˆ–é¶´æ©‹é¢¨æœˆã€‚", aiGuide: "å°éŠè§€é»ï¼šé€™é–“é€šå¸¸æ’éšŠå¾ˆé•·ã€‚é•·è¼©æ‹å®Œè·‘è·‘äººå³å¯ï¼Œè¦–é«”åŠ›æ±ºå®šæ˜¯å¦æ’éšŠã€‚", mustEat: "å±±èŠ‹ç‡’ã€‚" },
                    { t: "21:00", s: "ğŸ“ å¿…è²·ä¼´æ‰‹ç¦®èˆ‡å®µå¤œ", type: "è³¼ç‰©", i: "shopping-bag", n: "ç™¾è²¨è¶…å¸‚æˆ–é»‘é–€å¸‚å ´æƒè²¨ã€‚", m: "Daimaru", imgDetail: "https://images.unsplash.com/photo-1464960710542-5674033ed5f6?auto=format&fit=crop&w=800", detailTitle: "ä¼´æ‰‹ç¦®æ¡è²·", intro: "å›é£¯åº—å‰å¿…é€›ã€‚è‰è“ã€è‚‰åŒ…ã€èµ·å¸è›‹ç³•å¿…è²·ã€‚", aiGuide: "å°éŠè§€é»ï¼š3æœˆé™å®šå¤éƒ½è¯è‰è“ï¼é‚„æœ‰ 551 è‚‰åŒ…èˆ‡è€çˆºçˆºèµ·å¸è›‹ç³•ã€‚", mustEat: "å¤éƒ½è¯è‰è“ã€551è‚‰åŒ…ã€‚" }
                ] 
            },
            2: { label: "Day 2 å½±åŸãƒ»å¤¢å¹»ç‹‚æ­¡", loc: "å¤§é˜ª", engLoc: "Osaka", img: "https://i.ibb.co/Fb2MnJ7h/image.jpg", stamina: 40, events: [{ t: "09:00", s: "ç’°çƒå½±åŸ USJ", type: "æ™¯é»", i: "ticket-alt", n: "å…¨æ—¥å½±åŸä¹‹æ—…ã€‚", m: "USJ", imgDetail: "https://images.unsplash.com/photo-1624316812891-b3b3a6230919?auto=format&fit=crop&w=1200", detailTitle: "USJ å†’éšª", intro: "é€²å…¥ä»»å¤©å ‚èˆ‡å“ˆåˆ©æ³¢ç‰¹ä¸–ç•Œã€‚", aiGuide: "å°éŠè§€é»ï¼šé•·è¼©å»ºè­°ç§Ÿç”¨è¼ªæ¤…ï¼Œä¿ç•™é«”åŠ›ã€‚" }] },
            3: { 
                label: "Day 3 å¥ˆè‰¯ãƒ»ç¥é¹¿æ–‡åŒ–", loc: "å¥ˆè‰¯", engLoc: "Nara", img: "https://i.ibb.co/Rp5Zt2vJ/image.jpg", stamina: 70, 
                events: [
                    { t: "10:30", s: "å¥ˆè‰¯å…¬åœ’ & æ±å¤§å¯º", type: "æ™¯é»", i: "hippo", n: "é¤µé£Ÿå°é¹¿èˆ‡åƒæ‹œå¤§ä½›ã€‚", m: "Todaiji", imgDetail: "https://i.ibb.co/ksgDLctq/image.jpg", detailTitle: "å¥ˆè‰¯é¹¿ & å¤§ä½›", intro: "å¥ˆè‰¯å…¬åœ’å¹³å¦å¥½èµ°ï¼Œé•·è¼©å¯ä»¥ååœ¨é•·æ¤…ä¸Šé¤µé¹¿ã€‚æ±å¤§å¯ºå¤§ä½›æ¥µéœ‡æ’¼ä¸”æœ‰ç„¡éšœç¤™å¡é“ã€‚", aiGuide: "å°éŠè§€é»ï¼šæœ‰ç„¡éšœç¤™å¡é“ï¼Œé•·è¼©èƒ½è¼•é¬†é€²å…¥åƒè§€å¤§ä½›ã€‚", mustEat: "å¤§ä½›å¸ƒä¸ã€‚", accessible: true },
                    { t: "13:00", s: "å¥ˆè‰¯åˆé¤ï¼šè€è¡—å®šé£Ÿ", type: "ç¾é£Ÿ", i: "utensils", n: "å¿—æ´¥é¦™é‡œé£¯æˆ–è€è¡—å®šé£Ÿã€‚", m: "Shizuka", imgDetail: "https://i.ibb.co/hRXB7hKW/image.jpg", detailTitle: "å¥ˆè‰¯è€è¡—å‘³", intro: "å»ºè­°å®‰æ’å¿—æ´¥é¦™é‡œé£¯æˆ–åœ¨å¥ˆè‰¯è€è¡—äº«ç”¨ç²¾ç·»å®šé£Ÿã€‚", aiGuide: "å°éŠè§€é»ï¼šè€è¡—æ°£æ°›å¹½éœï¼Œé©åˆé•·è¼©æ…¢æ…¢ç”¨é¤ã€‚" },
                    { t: "15:30", s: "å®‡æ²» å¹³ç­‰é™¢ (é¸æ“‡æ€§)", type: "æ™¯é»", i: "leaf", n: "çµ•ç¾é³³å‡°å ‚èˆ‡æŠ¹èŒ¶é«”é©—ã€‚", m: "Byodoin", imgDetail: "https://i.ibb.co/vx1ptgT0/image.jpg", detailTitle: "å®‡æ²»æŠ¹èŒ¶é¦™", intro: "è‹¥é•·è¼©é«”åŠ›å°šå¯ï¼Œå¯é †é“å»çœ‹é³³å‡°å ‚ï¼›è‹¥ç´¯äº†å‰‡ç›´æ¥é€²äº¬éƒ½é£¯åº—ã€‚", aiGuide: "å°éŠè§€é»ï¼šé«”åŠ›å½ˆæ€§é»ã€‚å®‡æ²»æ²³é‚Šé¢¨æ™¯æ¥µä½³ã€‚", accessible: true },
                    { t: "18:00", s: "äº¬éƒ½å…¥ä½ & æ™šé¤", type: "ç¾é£Ÿ", i: "hotel", n: "ä¼Šå‹¢ä¸¹ç™¾è²¨æ™šé¤ã€‚", m: "Kyoto+Station", imgDetail: "https://images.unsplash.com/photo-1528164344705-4754268799af?auto=format&fit=crop&w=1200", detailTitle: "äº¬éƒ½ä¹‹å¤œ", intro: "åœ¨äº¬éƒ½è»Šç«™å‘¨é‚Šç”¨é¤ï¼ˆå¦‚ä¼Šå‹¢ä¸¹ç™¾è²¨æ¨“ä¸Šçš„å’Œç‰›æˆ–å£½å–œç‡’ï¼‰ã€‚", aiGuide: "å°éŠè§€é»ï¼šä¼Šå‹¢ä¸¹11æ¨“çš„å’Œç‰›æ–™ç†ç’°å¢ƒèˆ’é©ã€‚" }
                ] 
            },
            4: { 
                label: "Day 4 äº¬éƒ½ãƒ»çµ•ç¾æ•£ç­–", loc: "äº¬éƒ½", engLoc: "Kyoto", img: "https://i.ibb.co/PzY0SDLD/image.jpg", stamina: 65, 
                events: [
                    { t: "09:30", s: "æ¸…æ°´å¯ºåƒæ‹œ", type: "æ™¯é»", i: "torii-gate", n: "äº¬éƒ½åœ‹å¯¶ï¼Œé çœºæ¸…æ°´èˆå°ã€‚", m: "Kiyomizu", imgDetail: "https://i.ibb.co/8nLR731B/image.jpg", detailTitle: "æ¸…æ°´èˆå°", intro: "æ—©æ™¨çœ‹æ¸…æ°´èˆå°äººæ½®è¼ƒå°‘ã€‚ç”±å¸æ©Ÿé»å°é»æ¥é€ã€‚", aiGuide: "å°éŠè§€é»ï¼šåŒ…è»Šå¸æ©Ÿå¯é€è‡³é–€å£ï¼Œçœå»æ­¥è¡Œè² æ“”ã€‚", accessible: false },
                    { t: "11:30", s: "ç¥—åœ’ / èŠ±è¦‹å°è·¯", type: "æ™¯é»", i: "walking", n: "å¤éƒ½è¡—é“èˆ‡åˆé¤ã€‚", m: "Gion", imgDetail: "https://i.ibb.co/BKT0rMnc/image.jpg", detailTitle: "å¤éƒ½é¢¨æƒ…", intro: "æ¼«æ­¥æ‹ç…§ï¼Œäº«ç”¨ç²¾ç·»åˆé¤ã€‚æ­¤å€å¹³å¦å¥½èµ°ã€‚", aiGuide: "å°éŠè§€é»ï¼šèŠ±è¦‹å°è·¯æ‹ç…§éå¸¸æœ‰å‘³é“ã€‚" },
                    { t: "14:00", s: "é‡‘é–£å¯º (å¿…çœ‹é †å…‰)", type: "æ™¯é»", i: "sun", n: "åˆå¾Œæœ€é–ƒè€€çš„æ™‚åˆ»ã€‚", m: "Kinkakuji", imgDetail: "https://i.ibb.co/nN541XSx/image.jpg", detailTitle: "é‡‘é–£è€€çœ¼æ™‚åˆ»", intro: "ä¸‹åˆé™½å…‰ç…§åœ¨é‡‘é–£å¯ºä¸Šå‘ˆç¾å®Œç¾é‡‘å…‰ã€‚åŒ…è»Šç›´é”é–€å£ã€‚", aiGuide: "å°éŠè§€é»ï¼šä¸‹åˆæ˜¯æœ€ä½³æ‹æ”æ™‚é–“ï¼ˆé †å…‰ï¼‰ï¼Œç…§ç‰‡é‡‘å…‰é–ƒé–ƒã€‚", accessible: true },
                    { t: "15:30", s: "éŒ¦å¸‚å ´ æˆ– é´¨å·æ•£ç­–", type: "æ™¯é»", i: "coffee", n: "ç†±é¬§å¸‚é›†æˆ–æ²³é‚Šæ•£å¿ƒã€‚", m: "Nishiki", imgDetail: "https://i.ibb.co/ymfdnwYS/image.jpg", detailTitle: "äº¬éƒ½æ•£ç­–å‚™é¸", intro: "å¹´è¼•äººé€›éŒ¦å¸‚å ´ï¼›é•·è¼©ç´¯äº†å¯å»é´¨å·é‚Šå–å’–å•¡æ•£æ­¥ã€‚", aiGuide: "å°éŠè§€é»ï¼šé´¨å·é‚Šé¢¨å¹éä¾†å¾ˆèˆ’æœï¼Œé©åˆæ”¾é¬†ã€‚" }
                ] 
            },
            5: { 
                label: "Day 5 åµå±±ãƒ»æºªè°·æ¼«éŠ", loc: "äº¬éƒ½", engLoc: "Kyoto", img: "https://i.ibb.co/JFxL6W1q/image.jpg", stamina: 75, 
                events: [
                    { t: "10:00", s: "åµå±±å°ç«è»Š", type: "äº¤é€š", i: "train", n: "é¾œå²¡ â” åµå±±è§€å…‰ä¹‹æ—…ã€‚", m: "Kameoka", imgDetail: "https://images.unsplash.com/photo-1545569341-9eb8b30979d9?auto=format&fit=crop&w=800", detailTitle: "è§€å…‰å°ç«è»Š", intro: "é å…ˆè¨‚å¥½ç¥¨ï¼Œæ¬£è³ä¿æ´¥å·æºªè°·ç¾æ™¯ã€‚", aiGuide: "å°éŠè§€é»ï¼šé•·è¼©æœ€æ„›çš„æ‚ é–’è³æ™¯æ–¹å¼ã€‚" },
                    { t: "11:30", s: "åµå±±å°Šæ¦®äººåŠ›è»Š", type: "é«”é©—", i: "walking", n: "å°Šæ¦®çœåŠ›è¡Œç¨‹ã€‚", m: "Arashiyama", imgDetail: "https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=800", detailTitle: "äººåŠ›è»Šé«”é©—", intro: "é ç´„äººåŠ›è»Šé€é•·è¼©é€²ç«¹æ—ã€‚å°Šæ¦®ä¸”å…æ­¥è¡Œã€‚", aiGuide: "å°éŠè§€é»ï¼šåµå±±æœ€çœåŠ›çš„è§€å…‰æ–¹å¼ï¼Œå¼·çƒˆå»ºè­°é ç´„ã€‚", reserved: true, accessible: true },
                    { t: "13:00", s: "åµå±±è±†è…æ–™ç†", type: "ç¾é£Ÿ", i: "utensils", n: "æ¸…æ·¡å¥åº·æ¹¯è±†è…ã€‚", m: "Arashiyama+Tofu", imgDetail: "https://images.unsplash.com/photo-1512832935301-df7ad7d4986c?auto=format&fit=crop&w=800", detailTitle: "å¥åº·æ¹¯è±†è…", intro: "è±†è…é¤å°é•·è¼©è…¸èƒƒè² æ“”å°ã€‚åµå±±æ­£å®—å‘³é“ã€‚", aiGuide: "å°éŠè§€é»ï¼šå„ªé›…æ¸…æ·¡ï¼Œé•·è¼©æ¥å—åº¦æ¥µé«˜ã€‚" },
                    { t: "15:00", s: "ä¼è¦‹ç¨»è·å¤§ç¤¾", type: "æ™¯é»", i: "torii-gate", n: "å¤§é³¥å±…åˆå½±ã€‚", m: "Fushimi", imgDetail: "https://images.unsplash.com/photo-1478436127897-769e1b3f0f36?auto=format&fit=crop&w=800", detailTitle: "åƒæœ¬é³¥å±…é–€å£", intro: "åªåœ¨å…¥å£æ‹ç…§ã€‚çµ•å°ä¸çˆ¬å¡ç¯€çœé«”åŠ›ã€‚", aiGuide: "å°éŠè§€é»ï¼šæ‹ç…§å³æ’¤é€€ï¼Œé«”åŠ›ç•™çµ¦æ™šé¤ã€‚", accessible: true }
                ] 
            },
            6: { 
                label: "Day 6 è³¦æ­¸ãƒ»æœ€å¾Œæ¡è²·", loc: "äº¬éƒ½", engLoc: "Kyoto", img: "https://i.ibb.co/ccRs1FZB/image.jpg", stamina: 95, 
                events: [
                    { t: "10:00", s: "äº¬éƒ½è»Šç«™æ¡è³¼", type: "è³¼ç‰©", i: "shopping-bag", n: "ä¼´æ‰‹ç¦®æœ€å¾Œè£œè²¨ã€‚", m: "Kyoto+Station", imgDetail: "https://images.unsplash.com/photo-1528164344705-4754268799af?auto=format&fit=crop&w=1200", detailTitle: "äº¬éƒ½æ¡è²·", intro: "è»Šç«™åœ°ä¸‹è¡—ä¸€æ¬¡è²·é½Šåç”¢ã€‚" },
                    { t: "14:00", s: "é—œè¥¿æ©Ÿå ´èµ·é£› | æ˜Ÿå®‡ JX823", type: "äº¤é€š", i: "plane-departure", n: "è¿”æŠµæ¡ƒåœ’æ©Ÿå ´ã€‚", m: "KIX", imgDetail: "https://images.unsplash.com/photo-1436491865332-7a61a109c0f3?auto=format&fit=crop&w=800", detailTitle: "å¹³å®‰è¿”å° JX823", intro: "æ˜Ÿå®‡ JX823 é è¨ˆ 16:15 æŠµé”æ¡ƒåœ’ã€‚", aiGuide: "å°éŠè§€é»ï¼šç­æ©Ÿ 14:00 èµ·é£›ã€‚å»ºè­° 11:30 æŠµé”è¾¦ç†ç™»æ©Ÿã€‚" }
                ] 
            }
        };

        const checkListData = ["è­·ç…§æ­£æœ¬", "æ—¥æœ¬ç¶²å¡", "æ—¥åœ“ç¾é‡‘", "å¸¸å‚™è—¥å“", "Visit Japan QR", "è¡Œå‹•é›»æº", "ä¿æš–å¤–å¥—"];

        // 2. ç‹€æ…‹è®Šæ•¸
        let user = null;
        let expenses = [];
        let exchangeRate = 0.211;

        // 3. UI æ ¸å¿ƒå‡½å¼
        window.switchDay = (d) => {
            const data = tourData[d];
            if (!data) return;

            const nav = document.getElementById('day-nav-container');
            if (nav) {
                nav.querySelectorAll('button').forEach(b => b.classList.remove('tab-active'));
                const targetTab = document.getElementById(`tab${d}`);
                if (targetTab) targetTab.classList.add('tab-active');
            }

            const headerImg = document.getElementById('header-bg');
            if (headerImg) {
                headerImg.style.opacity = '0';
                setTimeout(() => { 
                    headerImg.src = data.img; 
                    headerImg.style.opacity = '0.45'; 
                }, 300);
            }

            const ring = document.getElementById('stamina-ring');
            if (ring) {
                const dash = 176 - (176 * (data.stamina || 100) / 100);
                ring.style.strokeDashoffset = dash;
            }
            const staminaText = document.getElementById('stamina-val');
            if (staminaText) staminaText.innerText = (data.stamina || 100) + '%';

            let html = `<div class="fade-in space-y-6">`;
            data.events.forEach((e, idx) => {
                const badge = (e.type === 'é¤å»³' || e.type === 'ç¾é£Ÿ' || e.type === 'è³¼ç‰©' || e.type === 'é«”é©—') ? 'badge-food' : 'badge-spot';
                html += `
                    <div class="relative pl-8 mb-8 border-l-2 border-dashed border-gray-200 text-left" onclick="window.toggleTool('detail', ${d}, ${idx})">
                        <div class="absolute -left-2 top-0 w-4 h-4 rounded-full bg-[--kyoto-red] border-4 border-white shadow-md"></div>
                        <div class="bg-white rounded-[2rem] p-6 shadow-md border border-gray-50 active:scale-[0.97] transition-all">
                            <div class="flex justify-between items-center mb-4">
                                <span class="bg-[--bamboo-green] text-white text-[9px] px-3 py-1 rounded-full font-bold shadow-sm">${e.t}</span>
                                <div class="flex gap-2">
                                    ${e.reserved ? `<span class="bg-amber-100 text-amber-600 text-[8px] font-black px-2 py-1 rounded-lg border border-amber-200"><i class="fas fa-check-circle mr-1"></i>é ç´„</span>` : ''}
                                    ${e.accessible ? `<span class="bg-blue-50 text-blue-500 text-[8px] font-black px-2 py-1 rounded-lg border border-blue-100"><i class="fas fa-wheelchair mr-1"></i>å‹å–„</span>` : ''}
                                    <span class="${badge} text-[8px] font-black px-2.5 py-1 rounded-lg">${e.type}</span>
                                </div>
                            </div>
                            <h3 class="text-xl font-black text-gray-800 mb-2 kaity flex items-center">
                                <i class="fas fa-${e.i} mr-3 text-[--kyoto-red] text-lg opacity-80"></i>${e.s}
                            </h3>
                            <p class="text-xs text-gray-500 font-bold mb-4 line-clamp-1">${e.n}</p>
                            <div class="bg-red-50 text-[--kyoto-red] px-4 py-2.5 rounded-2xl text-[10px] font-black border border-red-100 flex items-center justify-between">
                                <span><i class="fas fa-eye mr-2"></i>æŸ¥çœ‹ç´°ç¯€èˆ‡ç¾é£Ÿæ”»ç•¥é»</span>
                                <i class="fas fa-chevron-right text-[8px] opacity-40"></i>
                            </div>
                        </div>
                    </div>`;
            });
            const container = document.getElementById('main-content');
            if (container) container.innerHTML = html + `</div>`;
            
            updateWeatherUI(data.loc, data.engLoc);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.toggleTool = (type, day, idx) => {
            const modal = document.getElementById('tool-modal');
            const body = document.getElementById('modal-body');
            if (!modal || !body) return;
            
            modal.classList.remove('hidden');
            body.innerHTML = '<div class="p-20 text-center"><i class="fas fa-circle-notch fa-spin text-4xl text-gray-300"></i></div>';
            
            setTimeout(() => {
                if (type === 'calc') {
                    body.innerHTML = `<div class="p-10 text-left fade-in"><h3 class="text-3xl font-black kaity mb-6 text-gray-900">åŒ¯ç‡æ›ç®—</h3><div class="mb-6 bg-yellow-50 p-6 rounded-3xl border border-yellow-100 px-6 py-4"><p class="text-[10px] text-yellow-600 font-bold">ç›®å‰åŒ¯ç‡</p><p class="text-xl font-bold font-mono">${window.liveRateText || '1 JPY = 0.211 TWD'}</p></div><div class="mb-8"><label class="text-[11px] font-black text-gray-400 block mb-2 font-mono">æ—¥åœ“ (JPY)</label><input type="number" id="jpy-input" class="w-full text-5xl font-black border-b-4 border-[--osaka-gold] py-4 outline-none bg-transparent" oninput="window.runConversion()" placeholder="Â¥"></div><div><label class="text-[11px] font-black text-gray-400 block mb-2 font-mono">å°å¹£ (TWD)</label><p id="twd-output" class="text-6xl font-black text-[--kyoto-red] mt-2">0</p></div></div>`;
                } else if (type === 'ledger') {
                    body.innerHTML = `
                        <div class="p-8 text-left fade-in">
                            <h3 class="text-3xl font-black kaity mb-6">å®¶æ—è¨˜å¸³</h3>
                            <div class="bg-emerald-600 p-8 rounded-[2.5rem] shadow-xl text-white mb-8 text-center">
                                <p class="text-emerald-100 text-xs mb-1 uppercase font-black">åˆ†æ”¤ç¸½è¨ˆ (8ä½)</p>
                                <p id="ledger-total-jpy" class="text-4xl font-black font-mono">Â¥ 0</p>
                            </div>
                            <div class="flex gap-3 mb-8">
                                <input type="text" id="ledger-item-name" placeholder="å“é …" class="flex-1 bg-white rounded-2xl p-4 outline-none border border-gray-100">
                                <input type="number" id="ledger-item-amount" placeholder="Â¥" class="w-24 bg-white rounded-2xl p-4 outline-none border border-gray-100">
                                <button onclick="window.addExpense()" class="bg-emerald-600 text-white w-14 rounded-2xl flex items-center justify-center btn-press"><i class="fas fa-plus"></i></button>
                            </div>
                            <div id="ledger-list" class="space-y-4 mb-8"></div>
                            
                            <!-- åµŒå…¥åˆ†å¸³é€£çµ -->
                            <div class="mt-10 pt-8 border-t border-gray-100">
                                <a href="https://liff.line.me/1655320992-Y8GowEpw/g/2jGf3BAwhK1jsbnwmPN7BQ" target="_blank" 
                                   class="block w-full py-5 bg-[#06C755] text-white rounded-[2rem] text-center text-sm font-black shadow-lg btn-press flex items-center justify-center gap-3">
                                   <i class="fab fa-line text-2xl"></i>é–‹å•Ÿ LINE å®¶æ—åˆ†å¸³ç¾¤çµ„
                                </a>
                                <p class="text-[9px] text-gray-400 text-center mt-3 font-bold uppercase tracking-widest">é»æ“Šè·³è½‰è‡³ LINE å°ˆæ¥­åˆ†å¸³å·¥å…·</p>
                            </div>
                        </div>`;
                    renderLedger();
                } else if (type === 'trans') {
                    body.innerHTML = `<div class="p-10 text-left fade-in"><h3 class="text-3xl font-black kaity mb-6">AI ç¿»è­¯åŠ©æ‰‹</h3><textarea id="trans-text" rows="4" placeholder="ä¾‹å¦‚ï¼šé€™é“èœå¯ä»¥ä¸åŠ è”¥å—ï¼Ÿ" class="w-full bg-white border border-gray-100 rounded-3xl p-6 text-lg mb-6 outline-none shadow-sm"></textarea><button onclick="window.askAI()" id="ai-btn" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black shadow-lg">ç¿»è­¯æˆæ—¥æ–‡</button><div id="ai-result" class="mt-8 p-6 bg-white rounded-3xl hidden border-2 border-blue-100 flex items-center justify-between shadow-sm"><div class="flex-1"><p id="res-jp" class="text-2xl font-black text-blue-900"></p><p id="res-romaji" class="text-xs italic mt-2 text-blue-400"></p></div><div class="flex flex-col gap-2"><button onclick="window.speakJP(document.getElementById('res-jp').innerText)" class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-volume-up"></i></button></div></div></div>`;
                } else if (type === 'checklist') {
                    body.innerHTML = `<div class="p-10 text-left fade-in"><h3 class="text-3xl font-black kaity mb-6">è¡Œå‰æª¢æŸ¥</h3><div class="space-y-4">${checkListData.map(text => `<label class="checklist-item flex items-center gap-4 bg-white p-5 rounded-2xl border border-gray-100 shadow-sm"><input type="checkbox" class="w-6 h-6 rounded-lg border-gray-300 text-[--kyoto-red] focus:ring-[--kyoto-red]"><span class="text-sm font-bold text-gray-700">${text}</span></label>`).join('')}</div></div>`;
                } else if (type === 'detail') {
                    const d = tourData[day].events[idx];
                    body.innerHTML = `<div class="fade-in"><div class="modal-immersive-header" style="background-image: url('${d.imgDetail}')"><div class="modal-immersive-overlay"></div><div class="absolute bottom-8 left-10 right-10 z-10"><span class="badge-spot text-[10px] px-5 py-2 rounded-full font-black mb-3 inline-block shadow-sm">${d.type}</span><h2 class="text-4xl font-black text-gray-900 kaity text-shadow-premium leading-tight">${d.detailTitle}</h2></div></div><div class="px-10 pb-16 pt-8 space-y-10"><section><h4 class="text-2xl font-black kaity border-l-4 border-[--kyoto-red] pl-4 mb-3">è©³ç´°ä»‹ç´¹</h4><p class="text-[15px] leading-relaxed text-gray-600">${d.intro}</p></section><section class="bg-white p-7 rounded-[2.5rem] border border-gray-100 shadow-sm"><h4 class="text-xl font-black kaity text-[--kyoto-red] mb-3">å°éŠè§€é»</h4><p class="text-[14px] font-bold italic text-gray-700">${d.aiGuide}</p></section><section><h4 class="text-xl font-black kaity border-l-4 border-[--osaka-gold] pl-4 mb-3">æ¨è–¦/å¿…é»</h4><div class="bg-[--osaka-gold]/5 p-5 rounded-2xl border border-[--osaka-gold]/10"><p class="text-[14px] font-black text-gray-800">${d.mustEat || d.n}</p></div></section><a href="https://www.google.com/maps/search/?api=1&query=${d.m}" target="_blank" class="block w-full py-6 bg-gray-900 text-white rounded-[2rem] text-center text-lg font-black kaity shadow-xl">é–‹å•Ÿ Google åœ°åœ–</a></div></div>`;
                }
            }, 100);
        };

        window.closeModal = () => document.getElementById('tool-modal').classList.add('hidden');

        window.runConversion = () => {
            const jpy = document.getElementById('jpy-input')?.value;
            const output = document.getElementById('twd-output');
            if (output && jpy) {
                output.innerText = (parseFloat(jpy) * exchangeRate).toLocaleString('zh-TW', {maximumFractionDigits: 1});
            }
        };

        // --- Weather API ---
        async function updateWeatherUI(city, eng) {
            const coords = eng === "Osaka" ? "latitude=34.69&longitude=135.50" : "latitude=35.01&longitude=135.77";
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?${coords}&current_weather=true`);
                if (!res.ok) return;
                const d = await res.json();
                const temp = Math.round(d.current_weather.temperature);
                const code = d.current_weather.weathercode;
                let icon = "fa-sun";
                if (code >= 1 && code <= 3) icon = "fa-cloud-sun";
                else if (code >= 51) icon = "fa-cloud-showers-heavy";
                
                const cityEl = document.getElementById('weather-city-name');
                const iconEl = document.getElementById('weather-icon-inline');
                const tempEl = document.getElementById('weather-temp-calligraphy');
                if (cityEl) cityEl.innerText = city;
                if (iconEl) iconEl.innerHTML = `<i class="fas ${icon}"></i>`;
                if (tempEl) tempEl.innerText = `${temp}Â°C`;
                
                const tip = document.getElementById('weather-tip');
                const tipText = document.getElementById('weather-tip-text');
                if (temp < 15 && tip && tipText) {
                    tip.classList.remove('hidden');
                    tipText.innerText = `ç¾åœ¨æ°£æº«ç´„ ${temp}Â°Cï¼Œé•·è¼©è¨˜å¾—æ”œå¸¶å¤–å¥—ä¿æš–ã€‚`;
                } else if (tip) { tip.classList.add('hidden'); }
            } catch (e) { console.warn("Weather API Fail"); }
        }

        // --- Firebase æ“ä½œ ---
        window.addExpense = async () => {
            if (!user) return;
            const n = document.getElementById('ledger-item-name')?.value;
            const a = parseFloat(document.getElementById('ledger-item-amount')?.value);
            if (!n || isNaN(a)) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                    name: n, amount: a, timestamp: Date.now()
                });
                document.getElementById('ledger-item-name').value = '';
                document.getElementById('ledger-item-amount').value = '';
            } catch (e) {}
        };

        window.deleteExpense = async (id) => {
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id)); } catch (e) {}
        };

        function renderLedger() {
            const list = document.getElementById('ledger-list');
            if (!list) return;
            const t = expenses.reduce((s, i) => s + i.amount, 0);
            const totalDisplay = document.getElementById('ledger-total-jpy');
            if (totalDisplay) totalDisplay.innerText = `Â¥ ${t.toLocaleString()}`;
            list.innerHTML = expenses.map(i => `<div class="flex justify-between items-center bg-white p-5 rounded-3xl shadow-sm border border-gray-100 font-bold fade-in"><div class="flex-1 font-black text-gray-800">${i.name}</div><div class="text-right flex items-center gap-4"><p class="text-lg text-[--kyoto-red] font-mono">Â¥ ${i.amount.toLocaleString()}</p><button onclick="window.deleteExpense('${i.id}')" class="text-gray-300 transition px-2"><i class="fas fa-trash-alt text-xs"></i></button></div></div>`).join('');
        }

        // --- Initialization ---
        window.onload = async () => {
            const nav = document.getElementById('day-nav-container');
            const dayNames = ["ç¬¬ä¸€æ—¥", "ç¬¬äºŒæ—¥", "ç¬¬ä¸‰æ—¥", "ç¬¬å››æ—¥", "ç¬¬äº”æ—¥", "ç¬¬å…­æ—¥"];
            if (nav) {
                nav.innerHTML = "";
                for(let i=1; i<=6; i++) {
                    nav.innerHTML += `<button onclick="window.switchDay(${i})" id="tab${i}" class="px-8 py-3 rounded-[1.5rem] bg-white text-gray-400 shadow-sm border border-gray-100 font-black transition-all text-xs text-center">${dayNames[i-1]}</button>`;
                }
            }
            try { window.switchDay(1); } catch (e) { console.error("Initial Render Fail"); }

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) {
                        const q = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                        onSnapshot(q, (snapshot) => {
                            expenses = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.timestamp - a.timestamp);
                            if (document.getElementById('ledger-list')) renderLedger();
                        }, (err) => {});
                    }
                });
                const rateRes = await fetch('https://open.er-api.com/v6/latest/JPY');
                if (rateRes.ok) {
                    const rateData = await rateRes.json();
                    exchangeRate = rateData.rates.TWD;
                    window.liveRateText = `1 JPY = ${exchangeRate.toFixed(3)} TWD`;
                }
            } catch (e) {}
        };
    </script>
</body>
</html>
